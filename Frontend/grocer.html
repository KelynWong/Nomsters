<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
      #map {
        height: 400px;
        width: 100%;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <h3>Grocers Nearby</h3>
    <!--The div element for the map -->
    <div class="container">
      <div class="row">
        <div class="col-3" style="background-color: grey">
          <!--Place where the forloop adds the location data-->
          <ul id="locations"></ul>
        </div>
        <div class="col-6">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <script>
      var location = "";
      var infoWindow = null; // Declare infoWindow variable outside of initMap function
      // Initialize and add the map
      async function initMap() {
        try {
          // Retrieves current location using google geolocation api
          const response = await axios.post(
            "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCdL4cw_-wypt03Y-7aj3fTEBewXmWtmwk",
            {}
          );
          var location = response.data.location;
        } catch (error) {
          console.log(error);
        }

        //Makes the map with how zoomed in it is using google places api

        var map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: location,
          mapId: "c076fb2f221a8a39",
        });

        //import  advanced marker elements library
        const { AdvancedMarkerElement } = await google.maps.importLibrary(
          "marker"
        );

        //Get data for marker elements for nearby grocery stores using places api

        const apiUrl = "http://localhost:3100/api/maps";
        var array_of_grocers = [];

        axios
          .get(apiUrl, {
            params: { location: location },
          })
          .then((response) => {
            // Retrives an array of nearby grocery stores
            array_of_grocers = response.data.results;
            console.log(array_of_grocers);

            //Set the number of results to display here
            for (let i = 0; i <= 5 & i < array_of_grocers.length; i++) {
              //Gets releavant display data for each grocery store
              let place_id = array_of_grocers[i].place_id;
              let name = array_of_grocers[i].name;
              let grocer_location = array_of_grocers[i].geometry.location;
              let grocer_rating = array_of_grocers[i].rating;
              let address = array_of_grocers[i].vicinity;
              //Some grocery stores do not have a open/close status so is by default false
              let openboolean = false;
              if (array_of_grocers[i].opening_hours.open_now) {
                openboolean = array_of_grocers[i].opening_hours.open_now;
              }
              if (openboolean == true) {
                openboolean = "Open";
              } else {
                openboolean = "Closed";
              }
              //Creates a link to google maps for each grocery store
              let mapLink = document.createElement("a");
              mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                name
              )}`;
              mapLink.innerText = "View on Google Maps";
              let line = document.createElement("li");
              let text = document.createTextNode(
                name + "\n" + address + "\n"
              );

              //Creates green or red text for open or closed depending on the status
              let open_text = document.createElement("p");
              open_text.innerText = openboolean;
              if (openboolean == "Open") {
                open_text.style.color = "green";
              } else {
                open_text.style.color = "red";
              }

              //append text and open status
              line.appendChild(text);
              line.appendChild(open_text);

              //Create and append star rating for each grocery store
              var empty_star =
                "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Empty_Star.svg/1200px-Empty_Star.svg.png";
              var star =
                "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Star%2A.svg/1117px-Star%2A.svg.png";
              var halfstar=
              "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Half_Star_Yellow.svg/1200px-Half_Star_Yellow.svg.png"
              var rating_int = parseFloat(grocer_rating);
              var br=document.createElement('br')
              if(grocer_rating=='0'){
                grocer_rating='No rating '
              }
              let rating_text= document.createTextNode(grocer_rating+' ')
              line.appendChild(br)
              line.appendChild(rating_text)
              while (rating_int >=0.5) {
                if(rating_int>=1){
                var star_img = document.createElement("img");
                star_img.src = star;
                star_img.width = 20;
                star_img.height = 20;
                line.appendChild(star_img);
                rating_int = rating_int - 1;}
                else{
                  var star_img = document.createElement("img");
                  star_img.src = halfstar;
                  star_img.width = 20;
                  star_img.height = 20;
                  line.appendChild(star_img);
                  rating_int = rating_int - 1;
                }
              }
              for(let i=0.5;i<5-Math.round(grocer_rating);i++){
                var star_img = document.createElement("img");
                star_img.src = empty_star;
                star_img.width = 20;
                star_img.height = 20;
                line.appendChild(star_img);
              }
              
              

    

              //append map link
              line.appendChild(br)
              line.appendChild(mapLink);

              //Append everything to locations
              document.getElementById("locations").appendChild(line);

              //Creates info window to show on click for grocery store
              infoWindow = new google.maps.InfoWindow({});

              //Creates a marker for each grocery store
              const markerImg = document.createElement("img");
              markerImg.width = 32;
              markerImg.height = 32;
              markerImg.src =
                "https://cdn-icons-png.flaticon.com/512/3419/3419665.png";
              const glyphSvgPinElement = new google.maps.marker.PinElement({
                glyph: markerImg,
              });
              const marker = new google.maps.marker.AdvancedMarkerElement({
                map,
                position: grocer_location,
                content: glyphSvgPinElement.element,
              });
              //On hover will show the name of the grocery store
              marker.title = name;

              marker.addListener("click", ({ domEvent, latLng }) => {
                const { target } = domEvent;
                infoWindow.close();
                //Sets what the popup window shows when you click a marker
                const contentString =
                  '<div id="content">' +
                  '<div id="siteNotice"></div>' +
                  '<h1 id="firstHeading" class="firstHeading">' +
                  name +
                  "</h1>" +
                  '<div id="bodyContent">' +
                  "<p>" +
                  address +
                  "<br>" +
                  grocer_rating +
                  " Stars</p>" +
                  "<p><b>Status: </b>" +
                  openboolean +
                  "</p>" +
                  '<p><a href="https://www.google.com/maps/search/?api=1&query=' +
                  encodeURIComponent(name) +
                  '">' +
                  "View on Google Maps</a></p>" +
                  "</div>" +
                  "</div>";

                infoWindow.setContent(contentString);
                infoWindow.open(marker.map, marker);
              });
            }
          })
          .catch((error) => {
            // Handle any errors here
            console.error(error);
          });

        // Add event listener to map object to close info window on click
        map.addListener("click", () => {
          if (infoWindow) {
            infoWindow.close();
          }
        });
      }
    </script>
    <script
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdL4cw_-wypt03Y-7aj3fTEBewXmWtmwk&callback=initMap"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
