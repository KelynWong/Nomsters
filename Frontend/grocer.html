<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Recipe</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

  <link rel="stylesheet" href="css/master.css">
  <link rel="stylesheet" href="css/grocer.css">

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/vue@next"></script>
</head>
  <body>
    <script>
      const token = sessionStorage.getItem('token');
      const userId = sessionStorage.getItem('userId');
        
        if (!token || !userId) {
            // If 'token' or 'userId' doesn't exist, redirect to 'index.html'
            window.location.href = './index.html';
        } 
    </script>
    
    <div id="app">
        <app-nav :allrecipes="allrecipes" @search="searchRecipes"></app-nav>
        <h3>Grocers Nearby</h3>
        <div class="container">
          <div class="row">
            <div class="col-3" style="background-color: grey">
              <!--Place where the forloop adds the location data-->
              <ul id="locations"></ul>
            </div>
            <div class="col-6">
              <!--The div element for the map -->
              <div id="map"></div>
            </div>
            <!--Place where the extra infomation is added on marker click-->
            <div
              class="col-3"
              id="extra_info"
              style="background-color: lightcoral"
            ></div>
          </div>
        </div>
        <app-footer></app-footer>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>

    <script src="component/navbar.js"></script>
    <script src="component/listing.js"></script>
    <script src="component/footer.js"></script>

    <script>
      const headers = {
        Authorization: `BEARER ${token}`
      }
      
      const app = Vue.createApp({
        components: {
            'app-footer': footer,
        },
        data() {
          return {
            allrecipes: []
          };
        },
        mounted() {
          this.fetchAllRecipes();
        },
        methods: {
          searchRecipes(titleQuery){
              window.location.href = `allRecipe.html?search=${titleQuery}`;
          },
          fetchAllRecipes(){
              axios.get('https://leaptron2.dscloud.me:3000/api/recipe', {
                  headers:{
                      Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTY5ODA0MzIwNCwiZXhwIjoxNjk4MTI5NjA0fQ.C5O7wzyWIo-1vGPBPGHtDyOTMVBvtReAZL9NKKJsOaw"
                  }
              }).then(response => {
                  console.log(response.data)
                  this.allrecipes = response.data
                  console.log(this.allrecipes)
              }).catch( error => {
                  console.log(error.response.data.message);
                  this.errorMessage = error.response.data.message;
                  this.allrecipes = [];
                  this.isError = true;
              });
          },
        }
      });
      
      app.component('app-nav', {
        data() {
            return {
                showIsActive: false,
                random: []
            }
        },
        props: {
            allrecipes: {
                type: Array,
                required: true
            },
            size: {
                type: Number,
                required: false,
                default: 12
            }
        },
        methods: {
            showHideModal() {
                this.showIsActive = !this.showIsActive;
  
                this.generateRandomRecipe();
            },
            generateRandomRecipe() {
                if (this.allrecipes.length > 0) {
                    const length = this.allrecipes.length;
                    const r = this.allrecipes[Math.floor(Math.random() * length)];
        
                    console.log(this.random);
                    this.random = r;
                }
            },
            closeModal() {
                this.showIsActive = !this.showIsActive;
            },
        },
        template: navbar.template + `
            <div class="random-recipe" :class="{active: showIsActive}">
                <div class="overlay" @click="closeModal"></div>
                <div class="modal-box">
                    <h3>Random Recipe Generator</h3>
                    ${listing.single}
                    <div class="buttons">
                        <!-- <button class="btn close-btn" @click="showHideModal">Close</button> -->
                        <button class="btn decide-btn" @click="generateRandomRecipe">Regenerate</button>
                        <button class="btn decide-btn"><a href="recipeDetail.html?">Go to Recipe</a></button>
                    </div>
                </div>
            </div>
          `,
      });

      app.mount('#app');
    </script>

    <script>
      //Initialise variables
      var location = "";
      var infoWindow = null;

      // Initialize and add the map
      async function initMap() {
        try {
          // Retrieves current location using google geolocation api
          const response = await axios.post(
            "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCdL4cw_-wypt03Y-7aj3fTEBewXmWtmwk",
            {}
          );
          var location = response.data.location;
        } catch (error) {
          console.log(error);
        }

        //Makes the map with how zoomed in it is using google map api

        var map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: location,
          mapId: "c076fb2f221a8a39",
        });

        //import  advanced marker elements library
        const { AdvancedMarkerElement } = await google.maps.importLibrary(
          "marker"
        );

        //Get data for marker elements for nearby grocery stores using places api

        const apiUrl = "https://leaptron2.dscloud.me:3000/api/maps/grocers";
        

        var array_of_grocers = [];
        //call maps.js which will call and retrive nearby places from google places api
        axios
          .get(apiUrl, {
            params: { location: location },
          })
          .then((response) => {
            // Retrives an array of nearby grocery stores
            array_of_grocers = response.data.results;
            console.log(array_of_grocers);

            //Set the number of results to display here(change the i<num to whatever number you want)
            for (let i = 0; (i <= 8) & (i < array_of_grocers.length); i++) {

              //Gets relevant display data for each grocery store
              //Unique id for each grocery store
              let place_id = array_of_grocers[i].place_id;
              //name = name of grocery store eg. Fairprice
              let name = array_of_grocers[i].name;
              //grocer location is the lat/longditude eg. (1.142124,1.492394)
              let grocer_location = array_of_grocers[i].geometry.location;
              //grocer rating is the rating of the grocery store eg. 4.5
              let grocer_rating = array_of_grocers[i].rating;
              //address is the address of the grocery store eg. 748c bedok reservoir
              let address = array_of_grocers[i].vicinity;
              //Some grocery stores do not have a open/close status so is by default false
              let openboolean = false;
              if (array_of_grocers[i].opening_hours) {
                openboolean = array_of_grocers[i].opening_hours.open_now;
              }
              //If the value called openboolean is true, set the text to say that its open
              if (openboolean == true) {
                openboolean = "Open";
              } else {
                openboolean = "Closed";
              }
              //Creates a link to google maps for each grocery store
              let mapLink = document.createElement("a");
              mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                name
              )}`;
              mapLink.innerText = "View on Google Maps";
              var br = document.createElement("br");
              let line = document.createElement("li");
              let linediv= document.createElement("div");
              //name is appened to h5 element
              let name_element = document.createElement("h5");
              name_element.innerText = name;
              //address is appened to address_text 
              let address_text = document.createTextNode(address);

              //Creates green or red text for open or closed depending on the status
              let open_text = document.createElement("p");
              open_text.innerText = openboolean;
              if (openboolean == "Open") {
                open_text.style.color = "green";
              } else {
                open_text.style.color = "red";
              }

              //append text,address and open status
              line.appendChild(name_element);
              line.appendChild(address_text);
              line.appendChild(open_text);

              //Create and append star rating for each grocery store
              var empty_star =
                "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Empty_Star.svg/1200px-Empty_Star.svg.png";
              var star =
                "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Star%2A.svg/1117px-Star%2A.svg.png";
              var halfstar =
                "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Half_Star_Yellow.svg/1200px-Half_Star_Yellow.svg.png";
              
              //Get the rating of grocer, if 0 means not rated
              var rating_int = parseFloat(grocer_rating);
              if (grocer_rating == "0") {
                grocer_rating = "No rating ";
              }
              //Rating text eg. 4.5
              let rating_text = document.createTextNode(grocer_rating + " ");
              line.appendChild(br);
              line.appendChild(rating_text);
              while (rating_int >= 0.5) {
                if (rating_int >= 1) {
                  //If remainjg rating is 1 or more, append full star
                  var star_img = document.createElement("img");
                  star_img.src = star;
                  star_img.width = 20;
                  star_img.height = 20;
                  line.appendChild(star_img);
                  rating_int = rating_int - 1;
                } else {
                  //If remaining rating is less than 1 but more than 0.5 eg. 0.7, append half star
                  var star_img = document.createElement("img");
                  star_img.src = halfstar;
                  star_img.width = 20;
                  star_img.height = 20;
                  line.appendChild(star_img);
                  rating_int = rating_int - 1;
                }
              }
              //append empty stars as necessary
              for (let i = 0.5; i < 5 - Math.round(grocer_rating); i++) {
                var star_img = document.createElement("img");
                star_img.src = empty_star;
                star_img.width = 20;
                star_img.height = 20;
                line.appendChild(star_img);
              }

              //append map link
              line.appendChild(br);
              line.appendChild(mapLink);
              linediv.appendChild(line);

              //Append everything to locations
              document.getElementById("locations").appendChild(linediv);

              //Creates info window to show on click for grocery store
              infoWindow = new google.maps.InfoWindow({});

              //Creates a marker for each grocery store
              const markerImg = document.createElement("img");
              markerImg.width = 32;
              markerImg.height = 32;
              //Set the marker image to a custom image
              markerImg.src =
                "https://cdn-icons-png.flaticon.com/512/3419/3419665.png";
              const glyphSvgPinElement = new google.maps.marker.PinElement({
                glyph: markerImg,
                background:'rgba(59,64,122,255)',
                borderColor:'white'
              });
              const marker = new google.maps.marker.AdvancedMarkerElement({
                map,
                position: grocer_location,
                content: glyphSvgPinElement.element,
              });
              //On hover will show the name of the grocery store
              marker.title = name;
              //If someone clicks on the marker, make all the side info appear
              marker.addListener("click", ({}) => {
            


                //**************************************************************************************//
                //                                                                                      //
                //                                                                                      //
                //Begin code of second call to location api to get more specific details on marker click//
                //                                                                                      //
                //                                                                                      //
                //**************************************************************************************//




                
                var detailsurl = "https://leaptron2.dscloud.me:3000/api/maps/details";
                //second call to location api with place_id to get more specific details on click

                //Inititalise variables
                phone_number = "";
                var timing_text = "No timings avaliable";
                var location_photo ="";
                //If a div already exists, remove it, this is so that when you click multiple markers it dosent just show both info.
                if(document.getElementById("Extra_details_div")){
                  let toremove=document.getElementById("Extra_details_div");
                  toremove.remove()
                }

                //Div containing all the extra details, will be appened to id=extrainfo div
                var Extra_details_div = document.createElement("div");
                Extra_details_div.id = "Extra_details_div";

                //Axios call to get specific details of the selected grocery store
                axios
                  .get(detailsurl, {
                    params: { place_id: place_id },
                  })
                  .then(async (response) => {
                    //Second div that contains phone number and opening/closing times
                    let extra_div = document.createElement("div");
                    
                    //Phone number Avaliable
                    phone_number = response.data.result.formatted_phone_number;
                    if (phone_number) {
                      phone_text = document.createTextNode('Contact Number: '+phone_number);
                      extra_div.appendChild(phone_text);
                    } 
                    else {
                      //No phone number avaliable
                      phone_para = document.createElement("p");
                      phone_text = document.createTextNode(
                        "No phone number avaliable"
                      );
                      phone_para.appendChild(phone_text);
                      extra_div.appendChild(phone_para);
                    }

                    //Paragraph showing opening times eg. monday:10am-11pm
                    timing_text =
                      response.data.result.current_opening_hours.weekday_text;
                    for (days of timing_text) {
                      let timing_list = document.createElement("li");
                      let timing_text_element = document.createTextNode(days);
                      timing_list.appendChild(timing_text_element);
                      extra_div.appendChild(timing_list);
                    }

                    //Append the second div to the main div
                    Extra_details_div.appendChild(extra_div);


                    //Call place photos api to see if theres any available photos
                    if (response.data.result.photos) {
                      photo_reference =
                        response.data.result.photos[0].photo_reference;
                      //Link to photo as given by google api
                      location_photo = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&maxheight=400&photoreference=${photo_reference}&key=AIzaSyCdL4cw_-wypt03Y-7aj3fTEBewXmWtmwk`;
                      let image=document.createElement("img");
                      image.src=location_photo;
                      //Set style of photo
                      image.style.width = "100%";
                      image.style.height = "100%";
                      //Div to contain photo 
                      let imagediv=document.createElement("div");
                      imagediv.appendChild(image);
                      //Append photo to main div
                      Extra_details_div.appendChild(imagediv);
                    }

                    //If no photos are found, set this as the default photo
                    else{
                      location_photo="https://t4.ftcdn.net/jpg/02/78/37/33/360_F_278373358_25gUoss2GtX0KJa8kJQmNcp872u6dTxW.jpg";
                      let image=document.createElement("img");
                       //Set style of photo
                      image.style.width = "100%";  
                      image.style.height = "100%"; 
                      image.src=location_photo;
                      //Div to contain photo 
                      let imagediv=document.createElement("div");
                      imagediv.appendChild(image);
                       //Append photo to main div
                      Extra_details_div.appendChild(imagediv);
                    }
                  });
                

                //**************************************************************************************//
                //                                                                                      //
                //Code below same as above call, obtain open now or not boolean, stars etc              //                                                              //
                //                                                                                      //
                //                                                                                      //
                //Can recode in the future to reuse some of the variables from the 1st call if got time,//
                //but this is safer/can edit style seperately if needed                                 //                                                       //
                //                                                                                      //
                //**************************************************************************************//
                

                //Display open or closed based on boolean
                let openboolean = false;
                if (array_of_grocers[i].opening_hours.open_now) {
                  openboolean = array_of_grocers[i].opening_hours.open_now;
                }
                if (openboolean == true) {
                  openboolean = "Open";
                } else {
                  openboolean = "Closed";
                }
                //Creates a link to google maps for the grocery store
                let mapLink = document.createElement("a");
                mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                  name
                )}`;
                mapLink.innerText = "View on Google Maps";
                var br = document.createElement("br");
                let line = document.createElement("li");
                //name is appened to h5 element
                let name_element = document.createElement("h5");
                name_element.innerText = name;
                //address is appened to text 2
                let address_text = document.createTextNode(address);

                //Creates green or red text for open or closed depending on the status
                let open_text = document.createElement("p");
                open_text.innerText = openboolean;
                if (openboolean == "Open") {
                  open_text.style.color = "green";
                } else {
                  open_text.style.color = "red";
                }
                let phone_text = document.createTextNode(phone_number + "\n");

                //append text, addreess, open status and phone number
                Extra_details_div.appendChild(name_element);
                Extra_details_div.appendChild(address_text);
                Extra_details_div.appendChild(open_text);
                Extra_details_div.appendChild(phone_text);

                //Create and append star rating for each grocery store
                var empty_star =
                  "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Empty_Star.svg/1200px-Empty_Star.svg.png";
                var star =
                  "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Star%2A.svg/1117px-Star%2A.svg.png";
                var halfstar =
                  "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Half_Star_Yellow.svg/1200px-Half_Star_Yellow.svg.png";
                var rating_int = parseFloat(grocer_rating);
                if (grocer_rating == "0") {
                  grocer_rating = "No rating ";
                }
                let rating_text = document.createTextNode(grocer_rating + " ");
                Extra_details_div.appendChild(br);
                Extra_details_div.appendChild(rating_text);
                while (rating_int >= 0.5) {
                  if (rating_int >= 1) {
                    var star_img = document.createElement("img");
                    star_img.src = star;
                    star_img.width = 20;
                    star_img.height = 20;
                    Extra_details_div.appendChild(star_img);
                    rating_int = rating_int - 1;
                  } else {
                    var star_img = document.createElement("img");
                    star_img.src = halfstar;
                    star_img.width = 20;
                    star_img.height = 20;
                    Extra_details_div.appendChild(star_img);
                    rating_int = rating_int - 1;
                  }
                }
                for (let i = 0.5; i < 5 - Math.round(grocer_rating); i++) {
                  var star_img = document.createElement("img");
                  star_img.src = empty_star;
                  star_img.width = 20;
                  star_img.height = 20;
                  Extra_details_div.appendChild(star_img);
                }

                //append map link
                Extra_details_div.appendChild(br);
                Extra_details_div.appendChild(mapLink);

                //Append everything to locations
                document.getElementById("extra_info").appendChild(Extra_details_div);

                //This is to display in the infowindow (small pop up on the map when u click the marker)
                const contentString =
                  '<div id="content">' +
                  '<div id="siteNotice"></div>' +
                  '<h1 id="firstHeading" class="firstHeading">' +
                  name +
                  "</h1>" +
                  '<div id="bodyContent">' +
                  "<p>" +
                  address +
                  "<br>" +
                  grocer_rating +
                  " Stars</p>" +
                  "<p><b>Status: </b>" +
                  openboolean +
                  "</p>" +
                  '<p><a href="https://www.google.com/maps/search/?api=1&query=' +
                  encodeURIComponent(name) +
                  '">' +
                  "View on Google Maps</a></p>" +
                  "</div>" +
                  "</div>";

                infoWindow.setContent(contentString);
                infoWindow.open(marker.map, marker);
              });
            }
          })
          .catch((error) => {
            // Handle any errors here
            console.error(error);
          });

        // Add event listener to map object to close info window on click
        map.addListener("click", () => {
          if (infoWindow) {
            infoWindow.close();
          }
        });
      }
    </script>
    <script
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdL4cw_-wypt03Y-7aj3fTEBewXmWtmwk&callback=initMap"
  ></script>
  </body>
</html>
