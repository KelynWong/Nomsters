<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Recipe</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <!-- Font awesome for icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">

  <link rel="stylesheet" href="css/master.css">
  <link rel="stylesheet" href="css/recipe.css">

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/vue@next"></script>
</head>
<body>
    <div id="app">
        <app-nav></app-nav>
        <h2>All Recipes</h2>
        <div class="recipeContent">
            <div class="dropdown d-flex justify-content-end">
                <button class="btn dropdown-toggle border border-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ selectedOption}}
                </button>
                <ul id="sort" class="dropdown-menu">
                    <li v-for="(option, index) in options" :key="index" >
                        <div class="dropdown-item" @click="selectOption(option); searchRecipes()">{{ option.label }}</div>
                    </li>
                </ul>
                <button @click="toggleSortDirection" class="btn btn-light">
                    <i v-if="sortDirection === 'ASC'" class="fas fa-chevron-up"></i>
                    <i v-else class="fas fa-chevron-down"></i>
                </button>
            </div>

            <div class="results">
                <div class="filter">
                    <button type="button" class="collapsible filter-header active">Dish Type <span>-</span></button>
                    <ul class="content col2" style="opacity: 1; height: auto;">
                        <li v-for="dishtype in dishtypes">
                            <input type="checkbox" :id="dishtype.id" name="dishtypes" :value="dishtype.value" @change="searchRecipes" v-model="dishtype.checked">
                            <label :for="dishtype.id">{{ dishtype.value }}</label><br>
                        </li>
                    </ul>

                    <button type="button" class="collapsible filter-header">Diet <span>+</span></button>
                    <ul class="content">
                        <li v-for="diet in diets">
                            <input type="checkbox" :id="diet.id" name="diets" :value="diet.value" @change="searchRecipes" v-model="diet.checked">
                            <label :for="diet.id">{{ diet.value }}</label><br>
                        </li>
                    </ul>

                    <button type="button" class="collapsible filter-header">Cuisine <span>+</span></button>
                    <ul class="content col2">
                        <li v-for="cuisine in cuisines">
                            <input type="checkbox" :id="cuisine.id" name="cuisines" :value="cuisine.value" @change="searchRecipes" v-model="cuisine.checked">
                            <label :for="cuisine.id">{{ cuisine.value }}</label><br>
                        </li>
                    </ul>

                    <!-- SELECT servings FROM nomsters.recipe GROUP BY servings; -->
                    <button type="button" class="collapsible filter-header">Serving <span>+</span></button>
                    <ul class="content col5">
                        <li v-for="serving in servings">
                            <input type="checkbox" :id="serving.id" name="servings" :value="serving.value" @change="searchRecipes">
                            <label :for="serving.id">{{ serving.value }}</label><br>
                        </li>
                    </ul>

                    <button type="button" class="collapsible filter-header">Ready In Minutes <span>+</span></button>
                    <div class="content col2">
                        <input type="checkbox" id="30" name="readyInMinutes" value="<= 30" @change="searchRecipes">
                        <label for="30">&lt;= 30mins</label><br>
                        <input type="checkbox" id="60" name="readyInMinutes" value="<= 60" @change="searchRecipes">
                        <label for="60">&lt;= 1hr</label><br>
                        <input type="checkbox" id="120" name="readyInMinutes" value="<= 120" @change="searchRecipes">
                        <label for="120">&lt;= 2hr</label><br>
                        <input type="checkbox" id="121" name="readyInMinutes" value="> 120" @change="searchRecipes">
                        <label for="121">&gt; 2hr</label><br>
                    </div>

                    <div class="filter-header">Calories</div>
                    <div class="min-max-slider" data-legendnum="2" id="calories">
                        <!-- <label for="min">Minimum Calorie</label> -->
                        <input id="min" class="min" name="minCalorie" type="range" step="1" :min="minCalorie" :max="maxCalorie" @change="searchRecipes"/>
                        <!-- <label for="max">Maximum Calorie</label> -->
                        <input id="max" class="max" name="maxCalorie" type="range" step="1" :min="minCalorie" :max="maxCalorie" @change="searchRecipes"/>
                    </div>

                    <div class="filter-header">Price Per Serving</div>
                    <div class="min-max-slider" data-legendnum="2" id="pricePerServing">
                        <!-- <label for="min">Minimum Price</label> -->
                        <input id="min" class="min" name="minPrice" type="range" step="1" :min="minPrice" :max="maxPrice" @change="searchRecipes"/>
                        <!-- <label for="max">Maximum Price</label> -->
                        <input id="max" class="max" name="maxPrice" type="range" step="1" :min="minPrice" :max="maxPrice" @change="searchRecipes"/>
                    </div>
                </div>
                <div class="container-listing-wrap">
                    <recipe-listing :recipe="recipes"></recipe-listing>
                </div>
            </div>
        </div>
        <app-footer></app-footer>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
    <script src="component/navbar.js"></script>
    <script src="component/listing.js"></script>
    <script src="component/footer.js"></script>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // indexes: createIndex(),
                    selectedOption: 'Sort by',
                    options: [
                        { label: 'Popularity', value: 'aggregateLikes' },
                        { label: 'Healthiness', value: 'healthScore' },
                    ],
                    dishtypes: [],
                    diets: [],
                    cuisines: [],
                    servings: [
                        { value: '1' },
                        { value: '2' },
                        { value: '3' },
                        { value: '4' },
                        { value: '5' },
                        { value: '6' },
                        { value: '7' },
                        { value: '8' },
                        { value: '9' },
                        { value: '10' },
                        { value: '11' },
                        { value: '12' },
                        { value: '13' },
                        { value: '14' },
                        { value: '15' },
                        { value: '16' },
                    ],
                    minCalorie: 14.38,
                    maxCalorie: 1788.67,
                    minPrice: 4.37,
                    maxPrice: 2371.08,
                    sortDirection: "ASC",
                    recipes: [],
                    searchTitle: "",
                };
            },
            mounted() {
                this.fetchDiets();
                this.fetchCuisines();
                this.fetchDishTypes();
                this.searchRecipes();
            },
            computed: {
                selectedDishtypes() {
                    const selectedItems = this.dishtypes.filter(item => item.checked).map(item => item.value);
                    return selectedItems.join(', '); 
                },
                selectedDiets() {
                    const selectedItems = this.diets.filter(item => item.checked).map(item => item.value);
                    return selectedItems.join(', '); 
                },
                selectedCuisines() {
                    const selectedItems = this.cuisines.filter(item => item.checked).map(item => item.value);
                    return selectedItems.join(', '); 
                },
            },
            methods: {
                selectOption(option) {
                    this.selectedOption = option.label;
                },
                fetchDiets(){
                    axios.get('https://leaptron2.dscloud.me:3000/api/diet', {
                        headers:{
                            Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTY5Nzk1NjI3MiwiZXhwIjoxNjk4MDQyNjcyfQ.VvgZqhMdDe0RPVLG6zIfoKwla_88PjC3SzR6BQ_FJtQ"
                        }
                    }).then(response => {
                        this.diets = response.data.map(item => ({
                            id: item.name.replace(/\s+/g, '_').toLowerCase(),
                            value: item.name,
                            checked: false
                        }))
                    }).catch( error => {
                        console.log(error.message);
                    });
                },
                fetchCuisines(){
                    axios.get('https://leaptron2.dscloud.me:3000/api/cuisine', {
                        headers:{
                            Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTY5Nzk1NjI3MiwiZXhwIjoxNjk4MDQyNjcyfQ.VvgZqhMdDe0RPVLG6zIfoKwla_88PjC3SzR6BQ_FJtQ"
                        }
                    }).then(response => {
                        this.cuisines = response.data.map(item => ({
                            id: item.name.replace(/\s+/g, '_').toLowerCase(),
                            value: item.name,
                            checked: false
                        }))
                    }).catch( error => {
                        console.log(error.message);
                    });
                },
                fetchDishTypes(){
                    axios.get('https://leaptron2.dscloud.me:3000/api/dishType', {
                        headers:{
                            Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTY5Nzk1NjI3MiwiZXhwIjoxNjk4MDQyNjcyfQ.VvgZqhMdDe0RPVLG6zIfoKwla_88PjC3SzR6BQ_FJtQ"
                        }
                    }).then(response => {
                        this.dishtypes = response.data.map(item => ({
                            id: item.name.replace(/\s+/g, '_').toLowerCase(),
                            value: item.name,
                            checked: false
                        }))
                    }).catch( error => {
                        console.log(error.message);
                    });
                },
                searchRecipes(){
                    axios.get('https://leaptron2.dscloud.me:3000/api/recipe', {
                        headers:{
                            Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTY5Nzk1NjI3MiwiZXhwIjoxNjk4MDQyNjcyfQ.VvgZqhMdDe0RPVLG6zIfoKwla_88PjC3SzR6BQ_FJtQ"
                        },
                        params: {
                            title: this.searchTitle, // not done
                            cuisine: this.selectedCuisines,
                            dishtype: this.selectedDishtypes,
                            diet: this.selectedDiets,
                            servings: this.selectedServings, // not done
                            minCalories: this.selectedMinCalories, // not done
                            maxCalories: this.selectedMaxCalories, // not done
                            minPrice: this.selectedMinPrice, // not done
                            maxPrice: this.selectedMaxPrice, // not done
                            minReadyInMinutes: this.selectedMinReadyInMinutes, // not done
                            maxReadyInMinutes: this.selectedMaxReadyInMinutes, // not done
                            sort: this.selectedSort, // not done
                            order: this.sortDirection
                        }
                    }).then(response => {
                        console.log(this.selectedDishtypes)
                        console.log(response.data)
                        this.recipes = response.data
                    }).catch( error => {
                        console.log(error.message);
                    });
                },
                toggleSortDirection() {
                    this.sortDirection = this.sortDirection === 'ASC' ? 'DESC' : 'ASC';
                }
            }, 
            watch: {
                sortDirection: 'searchRecipes', 
            }
        });


        app.component('app-nav', navbar);
        app.component('app-footer', footer);
        app.component('recipe-listing', {
            data() {
                return {
                    pageNumber: 1
                }
            },
            props: {
                recipe: {
                    type: Array,
                    required: true
                },
                size: {
                    type: Number,
                    required: false,
                    default: 12
                }
            },
            methods:{
                nextPage() {
                this.pageNumber++;
                },
                prevPage() {
                this.pageNumber--;
                }
            },
            computed: {
                pageCount() {
                    let l = this.recipe.length;
                    let s = this.size;
                    return Math.ceil(l/s);
                },
                recipeData() {
                    const start = this.pageNumber * this.size - this.size;
                    const end = start + this.size;
                    return this.recipe.slice(start, end);
                }
            },
            template: listing.template + `
                <div class="m-4 d-flex align-items-center">
                    <p class="m-1">Total {{ pageCount }} pages</p>
                    <button type="button" class="btn btn-sm m-1" v-if="pageNumber > 1" @click="prevPage"> &lt; </button>
                    <button type="button" class="btn btn-sm m-1 text-secondary border-0" v-else disabled> &lt; </button>
                    <button type="button" class="btn btn-sm m-1 rounded-circle" :class="{ 'btn-dark': pageNumber === page }" v-for="page in pageCount" @click="pageNumber = page"> {{ page }}
                    </button>
                    <button type="button" class="btn btn-sm m-1" v-if="pageNumber < pageCount" @click="nextPage"> &gt; </button>
                    <button type="button" class="btn btn-sm m-1 text-secondary border-0" v-else disabled> &gt; </button>
                </div>
            `
        });

        function createIndex(){
            let index = [];
            for(let i = 1; i < 100; i++) {
                if (i < 10) {
                    index.push({
                        ind:'#' + i,
                        fav: 1
                    });
                } else {
                    index.push({
                        ind:'#' + i,
                        fav: 0
                    });
                }
            }
            return index;
        }

        app.mount('#app');

    </script>

    <script>
        var collapsible = document.getElementsByClassName("collapsible");
        var i;

        for (i = 0; i < collapsible.length; i++) {
            collapsible[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.opacity === "1") {
                    content.style.opacity = "0";
                    content.style.height = "0";
                    this.getElementsByTagName("span")[0].innerText = "+";
                } else {
                    content.style.opacity = "1";
                    content.style.height = "auto";
                    this.getElementsByTagName("span")[0].innerText = "-";
                }
            });
        }

        var thumbsize = 14;

        function draw(slider,splitvalue) {

            /* set function vars */
            var id = slider.getAttribute('id');
            var min = slider.querySelector('.min');
            var max = slider.querySelector('.max');
            var lower = slider.querySelector('.lower');
            var upper = slider.querySelector('.upper');
            var legend = slider.querySelector('.legend');
            var thumbsize = parseInt(slider.getAttribute('data-thumbsize'));
            var rangewidth = parseInt(slider.getAttribute('data-rangewidth'));
            var rangemin = parseInt(slider.getAttribute('data-rangemin'));
            var rangemax = parseInt(slider.getAttribute('data-rangemax'));

            /* set min and max attributes */
            min.setAttribute('max',splitvalue);
            max.setAttribute('min',splitvalue);

            /* set css */
            min.style.width = parseInt(thumbsize + ((splitvalue - rangemin)/(rangemax - rangemin))*(rangewidth - (2*thumbsize)))+'px';
            max.style.width = parseInt(thumbsize + ((rangemax - splitvalue)/(rangemax - rangemin))*(rangewidth - (2*thumbsize)))+'px';
            min.style.left = '0px';
            max.style.left = parseInt(min.style.width)+'px';
            min.style.top = lower.offsetHeight+'px';
            max.style.top = lower.offsetHeight+'px';
            legend.style.marginTop = min.offsetHeight+'px';
            slider.style.height = (lower.offsetHeight + min.offsetHeight + legend.offsetHeight)+'px';
            
            /* correct for 1 off at the end */
            if(max.value>(rangemax - 1)) max.setAttribute('data-value',rangemax);

            /* write value and labels */
            max.value = max.getAttribute('data-value'); 
            min.value = min.getAttribute('data-value');

            if (id == "calories") {
                lower.innerHTML = min.getAttribute('data-value') + " kcal";
                upper.innerHTML = " " + max.getAttribute('data-value') + " kcal";
            } else {
                lower.innerHTML = min.getAttribute('data-value');
                upper.innerHTML = max.getAttribute('data-value');
            }

        }

        function init(slider) {
            /* set function vars */
            var id = slider.getAttribute('id');
            var min = slider.querySelector('.min');
            var max = slider.querySelector('.max');
            var rangemin = parseInt(min.getAttribute('min'));
            var rangemax = parseInt(max.getAttribute('max'));
            var avgvalue = (rangemin + rangemax)/2;
            var legendnum = slider.getAttribute('data-legendnum');

            /* set data-values */
            min.setAttribute('data-value',rangemin);
            max.setAttribute('data-value',rangemax);
            
            /* set data vars */
            slider.setAttribute('data-rangemin',rangemin); 
            slider.setAttribute('data-rangemax',rangemax); 
            slider.setAttribute('data-thumbsize',thumbsize); 
            slider.setAttribute('data-rangewidth',slider.offsetWidth);

            /* write labels */
            var lower = document.createElement('span');
            var upper = document.createElement('span');

            if (id == "pricePerServing") {
                lower.classList.add('lower','value','price');
                upper.classList.add('upper','value','price');
            } else {
                lower.classList.add('lower','value');
                upper.classList.add('upper','value');
            }
            
            lower.appendChild(document.createTextNode(rangemin));
            upper.appendChild(document.createTextNode(rangemax));
            
            slider.insertBefore(lower,min.previousElementSibling);
            slider.insertBefore(upper,min.previousElementSibling);
            
            /* write legend */
            var legend = document.createElement('div');
            legend.classList.add('legend');
            var legendvalues = [];
            for (var i = 0; i < legendnum; i++) {
                legendvalues[i] = document.createElement('div');
                var val = Math.round(rangemin+(i/(legendnum-1))*(rangemax - rangemin));
                legendvalues[i].appendChild(document.createTextNode(val));
                legend.appendChild(legendvalues[i]);

            } 
            slider.appendChild(legend);

            /* draw */
            draw(slider,avgvalue);

            /* events */
            min.addEventListener("input", function() {update(min);});
            max.addEventListener("input", function() {update(max);});
        }

        function update(el){
            /* set function vars */
            var slider = el.parentElement;
            var min = slider.querySelector('#min');
            var max = slider.querySelector('#max');
            var minvalue = Math.floor(min.value);
            var maxvalue = Math.floor(max.value);
            
            /* set inactive values before draw */
            min.setAttribute('data-value',minvalue);
            max.setAttribute('data-value',maxvalue);

            var avgvalue = (minvalue + maxvalue)/2;

            /* draw */
            draw(slider,avgvalue);
        }

        var sliders = document.querySelectorAll('.min-max-slider');
        sliders.forEach( function(slider) {
            init(slider);
        });
    </script>
</body>

</html>