<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <link rel="stylesheet" href="css/master.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/profile.css">

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@next"></script>
</head>

<body>

  <script>
    const token = sessionStorage.getItem('token');
    const userId = sessionStorage.getItem('userId');
      
    if (!token || !userId) {
        // If 'token' or 'userId' doesn't exist, redirect to 'index.html'
        window.location.href = './index.html';
    } 
  </script>

    <div id="app">

      <app-nav :allrecipes="allrecipes"></app-nav>

        <div class="banner">
        </div>
        <div class="box"></div>
       
        <div class="dp">
          <img :src="image" alt="logo" class="profilepic mx-auto" />
        </div>
        <br>
        <div class="text-center"><h2>Welcome back,</h2></div><br>
        <div class="username text-center">{{name}}</div>

        <div class="mt-5 mb-5 text-center"><a href="./editprofile.html"><button class="btn rounded btn-danger shadow-sm" style='font-weight:lighter' type="button">Edit Profile</button></a></div>

        <div class="row">
          <!-- <div class="col-2"></div> -->
          <!-- <div id="col-8 p-3"> -->
            <div class="container rounded section-head p-3 bg-light flex-row scrollmenu" >
              <h3 class="recipesShared">Recipes <span class="red">Shared</span></h3>
              
              <recipe-listing class="col-3 item" v-if="!isEmpty" :recipe="recipes"></recipe-listing>
              
              <div v-else class="alert alert-danger w-100 d-flex align-items-center justify-content-center" role="alert">
                <p>Post some recipes and it will be displayed here!</p>
              </div>
            </div>
          <!-- </div> -->
          <!-- <div class="col-2"></div> -->
        </div>
        
        <app-footer></app-footer>

    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
     integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
     crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script src="component/navbar.js"></script>
    <script src="component/listing.js"></script>
    <script src="component/footer.js"></script>

 <script>
   const headers = {
      Authorization: `BEARER ${token}`
    }

    const app = Vue.createApp({
      components: {
      },
      data() {
        return {
          allrecipes: [],
          recipes: [],
          name:'',
          image:'/img/icon/food.png',
          isEmpty: false
        };
      },
      mounted() {
        console.log(token)
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId, {
          headers: headers
        }).then(response => {
          console.log(response.data)
          this.name = response.data.username
        }).catch(error => {
          this.isError = true;
        });
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId, {
          headers: headers
        }).then(response => {
          var dataArray=response.data.image.data
          if(dataArray.length>0){
          
          console.log(dataArray )
          var uint8Array = new Uint8Array(dataArray);
          console.log(uint8Array)
          var binaryString = String.fromCharCode.apply(null, uint8Array);


          this.image = binaryString}
        }).catch(error => {
          this.isError = true;
        });
        
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId , {
          headers: headers
        }).then(response => {
       
        }).catch(error => {
          this.isError = true;
        });

        axios.get('https://leaptron2.dscloud.me:3000/api/recipe/user/' + userId , {
          headers: headers
        }).then(response => {
          this.recipes = response.data

          this.recipes.forEach((recipe) => {
              recipe.fav = 0; 
            });
          
            axios.get(`https://leaptron2.dscloud.me:3000/api/user/${userId}/recipe`, {
                        headers:headers,
                    }).then(response => {
                        response.data.forEach(favRecipe => {
                            const favedRecipe = this.recipes.find(recipe => recipe.recipeId === favRecipe.recipeId);
                                if (favedRecipe) {
                                    favedRecipe.fav = 1;
                                }
                            });
                        console.log(this.recipes)
                        
                    }).catch( error => {

                    });
        }).catch(error => {
          this.isEmpty = true;
        });

        this.fetchAllRecipes();
      },
      methods: {
        searchRecipes(titleQuery){
            window.location.href = `allRecipe.html?search=${titleQuery}`;
        },
        fetchAllRecipes(){
            axios.get('https://leaptron2.dscloud.me:3000/api/recipe', {
                headers:headers
            }).then(response => {
                this.allrecipes = response.data
            }).catch( error => {
                console.log(error.response.data.message);
                this.errorMessage = error.response.data.message;
                this.allrecipes = [];
                this.isError = true;
            });
        },
      }
    });
    
    app.component('app-nav', {
      data() {
          return {
              showIsActive: false,
              random: [],
              profileImage:"img/icon/profile.png",
              active: "profile"
          }
      },
      props: {
          allrecipes: {
              type: Array,
              required: true
          },
          size: {
              type: Number,
              required: false,
              default: 12
          }
      },
      methods: {
        ...navbar.methods,
          showHideModal() {
              this.showIsActive = !this.showIsActive;
              this.generateRandomRecipe();
          },
          generateRandomRecipe() {
              if (this.allrecipes.length > 0) {
                  const length = this.allrecipes.length;
                  const r = this.allrecipes[Math.floor(Math.random() * length)];
      
                  console.log(this.random);
                  this.random = r;
              }
          },
          closeModal() {
              this.showIsActive = !this.showIsActive;
          },
      },
      template: navbar.template + `
          <div class="random-recipe" :class="{active: showIsActive}">
              <div class="overlay" @click="closeModal"></div>
              <div class="modal-box">
                  <h3>Random Recipe Generator</h3>
                  ${listing.single}
                  <div class="buttons">
                      <button class="btn decide-btn generate" @click="generateRandomRecipe">Regenerate</button>
                      <button class="btn decide-btn generate"><a :href="'recipeDetail.html?id=' + random.recipeId">Go to Recipe</a></button>
                  </div>
              </div>
          </div>
        `,
        mounted(){
          axios.get(`https://leaptron2.dscloud.me:3000/api/user/${userId}`, {
            headers:headers,})
            .then(response => {
              console.log(response.data)
              var image = response.data.image.data
              if(image.length>0){
          var uint8Array = new Uint8Array(image);
          var binaryString = String.fromCharCode.apply(null, uint8Array);
          this.profileImage = binaryString
              } 
              })}
      });

    app.component('app-footer',footer);
     app.mount('#app');
    

  

      app.component('recipe-listing', {
      props: {
        recipe: {
          type: Array,
          required: true
        }
      },
      computed:{
        recipeData() {
          return this.recipe;
        }
      },
      methods: listing.methods,
      template: listing.template,  
    });
  
    </script>

    <!-- script for image preview -->
    <script>
        function preview() {
            frame.src = URL.createObjectURL(event.target.files[0]);
        }
        function clearImage() {
            document.getElementById('formFile').value = null;
            frame.src = "";
        }
    </script>
    </script>


   
</body>

</html>