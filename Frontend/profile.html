<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <link rel="stylesheet" href="css/master.css">
    <link rel="stylesheet" href="css/home.css">

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@next"></script>
</head>

<style>
    .add,
    .remove {
        margin-right: 5px;
        padding-top: 5px;
    }

    #formfield,
    #textbox,
    #formfield2,
    #textbox2 {
        margin-bottom: 5px;
    }

    .img-fluid {
        display: block;
        margin-left: auto;
        margin-right: auto;
        max-width: 50%;
    }

    .border-right {
        border-right: 1px solid #dee2e6 !important;
    }

    .profilepic {
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 200px;    
        z-index: 1000;
        margin-top: -100px;  
        }



    .banner {
        color: #ffffff; /* Text color */
        /* padding: 20px; */
        text-align: center;
        height: 200px;
        background-color: #DE352A;
    }

    h2 {
        margin-top: -10px;
    }

    .username {
        font-size: 30px;
    }

</style>

<body>

  <script>
    const token = sessionStorage.getItem('token');
    const userId = sessionStorage.getItem('userId');
      
    if (!token || !userId) {
        // If 'token' or 'userId' doesn't exist, redirect to 'index.html'
        window.location.href = './index.html';
    } 
  </script>

    <div id="app">

      <app-nav :allrecipes="allrecipes"></app-nav>

        <div class="banner">
        </div>
       
        <img :src="image" alt="logo" class="profilepic mx-auto" /><br>
        <div class="text-center"><h2>Welcome back,</h2></div><br>
        <div class="username text-center">{{name}}</div>

        <div class="mt-5 mb-5 text-center"><a href="./editprofile.html"><button class="btn rounded btn-danger shadow-sm" style='font-weight:lighter' type="button">Edit Profile</button></a></div>

        <div id="section6 p-3">
            <div class="section-head p-3 bg-light">
              <h3>Recipes <span class="red">Shared</span></h3>
              <recipe-listing :recipe="indexes"></recipe-listing>
            </div>
          
        </div>
        <app-footer></app-footer>

    </div>

     <!-- Bootstrap Bundle with Popper -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
     integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
     crossorigin="anonymous"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

 <script src="component/navbar.js"></script>
 <script src="component/listing.js"></script>
 <script src="component/footer.js"></script>

 <script>
   const headers = {
      Authorization: `BEARER ${token}`
    }

    const app = Vue.createApp({
      components: {
      },
      data() {
        return {
          indexes: createIndex(),
          allrecipes: [],
          name:'',
          image:'/img/icon/food.png'
        };
      },
      mounted() {
        console.log(token)
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId, {
          headers: headers
        }).then(response => {
          console.log(response.data)
          this.name = response.data.username
        }).catch(error => {
          this.isError = true;
        });
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId, {
          headers: headers
        }).then(response => {
          var dataArray=response.data.image.data
          if(dataArray.length>0){
          
          console.log(dataArray )
          var uint8Array = new Uint8Array(dataArray);
          console.log(uint8Array)
          var binaryString = String.fromCharCode.apply(null, uint8Array);


          this.image = binaryString}
        }).catch(error => {
          this.isError = true;
        });
        
        axios.get('https://leaptron2.dscloud.me:3000/api/user/' + userId , {
          headers: headers
        }).then(response => {
       
        }).catch(error => {
          this.isError = true;
        });
        this.fetchAllRecipes();
      },
      methods: {
        searchRecipes(titleQuery){
            window.location.href = `allRecipe.html?search=${titleQuery}`;
        },
        fetchAllRecipes(){
            axios.get('https://leaptron2.dscloud.me:3000/api/recipe', {
                headers:headers
            }).then(response => {
                console.log(response.data)
                this.allrecipes = response.data
                console.log(this.allrecipes)
            }).catch( error => {
                console.log(error.response.data.message);
                this.errorMessage = error.response.data.message;
                this.allrecipes = [];
                this.isError = true;
            });
        },
      }
    });
    
    app.component('app-nav', {
      data() {
          return {
              showIsActive: false,
              random: []
          }
      },
      props: {
          allrecipes: {
              type: Array,
              required: true
          },
          size: {
              type: Number,
              required: false,
              default: 12
          }
      },
      methods: {
          showHideModal() {
              this.showIsActive = !this.showIsActive;
              this.generateRandomRecipe();
          },
          generateRandomRecipe() {
              if (this.allrecipes.length > 0) {
                  const length = this.allrecipes.length;
                  const r = this.allrecipes[Math.floor(Math.random() * length)];
      
                  console.log(this.random);
                  this.random = r;
              }
          },
          closeModal() {
              this.showIsActive = !this.showIsActive;
          },
      },
      template: navbar.template + `
          <div class="random-recipe" :class="{active: showIsActive}">
              <div class="overlay" @click="closeModal"></div>
              <div class="modal-box">
                  <h3>Random Recipe Generator</h3>
                  ${listing.single}
                  <div class="buttons">
                      <button class="btn decide-btn" @click="generateRandomRecipe">Regenerate</button>
                      <button class="btn decide-btn"><a href="recipeDetail.html?">Go to Recipe</a></button>
                  </div>
              </div>
          </div>
        `,
      });

    app.component('app-footer',footer);
     app.mount('#app');
    

  

      app.component('recipe-listing', {
      props: {
        recipe: {
          type: Array,
          required: true
        }
      },
      data(){
        return{
          localrecipe:[],
        }
      },
      computed:{
        recipeData() {
          return this.localrecipe;
        }
      },
      template: listing.template ,  
    created() {
    // This code is executed when the component is created.
    
    // Example Axios GET request
    const token = sessionStorage.getItem('token');
    const userId = sessionStorage.getItem('userId');
      
    // to add in session logic
    const headers = {
      Authorization: `Bearer ${token}`
    };
    //to add in logic to get user diet
    axios.get('https://leaptron2.dscloud.me:3000/api/recipe/random?limit=3&readyInMinutes=700&diet=',{
      headers: headers
    })
      .then(response => {
        console.log(response)
        // Assuming the response contains recipe data
        this.localrecipe = response.data
      })
      .catch(error => {
        console.error('Error:', error);
      }); 
  }
    });
  
    function createIndex() {
      let index = [];
      for (let i = 1; i < 4; i++) {
        index.push({ ind: '#' + i });
      }
      return index;
    }
    </script>

    <!-- script for image preview -->
    <script>
        function preview() {
            frame.src = URL.createObjectURL(event.target.files[0]);
        }
        function clearImage() {
            document.getElementById('formFile').value = null;
            frame.src = "";
        }
    </script>
    </script>


   
</body>

</html>